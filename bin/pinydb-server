#!/usr/bin/env php
<?php
declare(strict_types=1);

//-- DEFAULT CONFIGS --//
$logfile    = '/tmp/pinydb.log';
$pidfile    = '/tmp/pinydb.pid';
$host       = '127.0.0.1';
$port       = 9999;
$dataDir    = '/pinydb-data';
$clientTimeout = 5;
$useFlock = true;


function logd( $msg = '' ) { 
    //add date
    $msg = "[".date('c')."] ".$msg."\n";
    echo $msg;
    //write to file
    file_put_contents( $logfile, $msg, FILE_APPEND );
}   


//-- LOADING DEPENDENCIES - COMPOSER AUTOLOAD --//
/**
 * Composer-ready server entry for PinyDB.
 * Example:
 *   pinydb-server -h 127.0.0.1 -P 9999 -d /path/to/data
 */

$autoloadCandidates = [
    // When running directly in this repo (development)
    __DIR__ . '/../vendor/autoload.php',
    // When installed as a dependency (vendor/symbolist/piny-db/bin/â€¦)
    __DIR__ . '/../../../autoload.php',
];

$loaded = false;
foreach ($autoloadCandidates as $file) {
    if (file_exists($file)) {
        require $file;
        $loaded = true;
        break;
    }
}

if (!$loaded) {
    logd('PinyDB: unable to locate autoload.php');
    exit(1);
}

// -- deamonizing -- //

//-- pidfile
foreach ($argv as $arg) {
    if (str_starts_with($arg, '--pidfile=')) {
        $pidfile = substr($arg, 10);
    }
}

$daemon = in_array('--daemon', $argv) || in_array('-d', $argv);

if ($daemon) {
    $pid = pcntl_fork();
    if ($pid < 0) {
        logd('Failed to fork');
        exit(1);
    }
    if ($pid > 0) {
        // Parent exits, child continues
        echo "PinyDB server daemonized, PID: $pid (pidfile -> $pidfile)\n";
        exit(0);
    }

    // Child becomes session leader
    posix_setsid();
}

if ($daemon) {
    file_put_contents($pidfile, getmypid());
}

//-- CMD OPTIONS HANDLING --//

use PinyDB\PinyDBServer;


$options = getopt('h:P:d:t:l:', ['host:', 'port:', 'data-dir:', 'client-timeout:', 'disable-flock', 'logfile:']);

$logfile = $options['l']      ?? $options['logfile']     ?? $logfile;
$host = $options['h']      ?? $options['host']     ?? $host;
$port = isset($options['P']) ? (int)$options['P']
      : (isset($options['port']) ? (int)$options['port'] : $port);
$dataDir = $options['d']   ?? $options['data-dir'] ?? (getcwd() . $dataDir);
$clientTimeout = isset($options['t']) ? (int)$options['t']
                : (isset($options['client-timeout']) ? (int)$options['client-timeout'] : $clientTimeout);
$useFlock = array_key_exists('disable-flock', $options) ? false : $useFlock;

if (!is_dir($dataDir)) {
    if (!mkdir($dataDir, 0777, true) && !is_dir($dataDir)) {
        logd("Failed to create data dir: {$dataDir}");
        exit(1);
    }
}




$server = new PinyDBServer($host, $port, $dataDir, $clientTimeout, $useFlock, $logfile);
$server->start();

